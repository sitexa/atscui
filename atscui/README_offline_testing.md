# 脱离仿真环境的模型测试工具

本文档介绍如何在不启动SUMO仿真环境的情况下测试训练好的强化学习模型。

## 背景

在原有的测试方式中（如 `run_model_zfdx_dqn.py`），模型测试需要启动完整的SUMO仿真环境，这样做有以下限制：

1. **依赖仿真环境**：需要SUMO软件和网络文件
2. **测试速度慢**：仿真环境启动和运行需要时间
3. **难以控制输入**：观测数据由仿真环境生成，难以测试特定场景
4. **调试困难**：无法精确控制输入来分析模型行为

## 解决方案

我们提供了两个脱离仿真环境的测试工具：

### 1. 简单快速测试 - `test_model_simple.py`

**用途**：快速验证模型是否能正常加载和预测

**特点**：
- 轻量级，运行速度快
- 基本功能验证
- 一致性测试
- 预定义场景测试

**使用方法**：
```bash
cd /Users/xnpeng/sumoptis/atscui
python atscui/test_model_simple.py
```

### 2. 详细离线测试 - `test_model_offline.py`

**用途**：全面测试模型在各种场景下的表现

**特点**：
- 多种测试场景
- 边界情况测试
- 现实交通场景模拟
- 详细的测试报告

**使用方法**：
```bash
cd /Users/xnpeng/sumoptis/atscui
python atscui/test_model_offline.py
```

## 测试内容

### 基本功能测试
1. **模型加载测试**：验证模型文件是否能正确加载
2. **预测功能测试**：验证模型能否正常进行预测
3. **一致性测试**：相同输入是否产生相同输出
4. **维度兼容性测试**：观测空间和动作空间是否匹配

### 场景测试
1. **低流量场景**：模拟交通流量较少的情况
2. **高流量场景**：模拟交通拥堵的情况
3. **不均衡流量**：模拟各方向流量不均的情况
4. **紧急情况**：模拟需要快速响应的场景

### 边界测试
1. **全零输入**：测试极端情况下的模型行为
2. **全一输入**：测试饱和状态下的模型行为
3. **随机输入**：测试模型的鲁棒性

## 观测数据格式

模型期望的观测向量（45维）包含：

```
观测向量 = [相位编码(4维) + 最小绿灯标志(1维) + 车道密度(20维) + 车道队列(20维) + CCI(1维) + 控制模式(1维)]
```

- **相位编码**：独热编码，表示当前激活的绿灯相位
- **最小绿灯标志**：0或1，表示是否满足最小绿灯时间
- **车道密度**：0-1之间的值，表示各车道的车辆密度
- **车道队列**：0-1之间的值，表示各车道的排队长度
- **CCI**：0-1之间的值，表示当前的拥堵指数
- **控制模式**：0或1，表示控制模式（0=顺序，1=灵活）

## 支持的算法

目前支持以下强化学习算法：
- **DQN**：Deep Q-Network
- **PPO**：Proximal Policy Optimization
- **A2C**：Advantage Actor-Critic
- **SAC**：Soft Actor-Critic

## 示例输出

### 快速测试输出示例
```
快速测试 DQN 模型
模型路径: /Users/xnpeng/sumoptis/atscui/models/zfdx-model-DQN.zip
✅ 模型加载成功
   观测空间: Box(0.0, 1.0, (45,), float32)
   动作空间: Discrete(4)
✅ 模型预测成功
   输入观测维度: (1, 45)
   输出动作: [2]
   动作类型: <class 'numpy.ndarray'>
✅ 一致性测试: 通过
```

### 场景测试输出示例
```
场景测试结果:
  低流量场景: 动作 = [0]
  高流量场景: 动作 = [1]
  混合场景: 动作 = [2]
✅ 场景测试完成
```

## 优势

与原有的仿真环境测试相比，脱离仿真环境的测试具有以下优势：

1. **独立性**：不依赖SUMO仿真环境，可以在任何环境中运行
2. **速度快**：无需启动仿真，测试速度大幅提升
3. **可控性**：可以精确控制输入数据，测试特定场景
4. **可重复性**：测试结果完全可重复
5. **调试友好**：便于分析模型在特定输入下的行为
6. **批量测试**：可以快速测试多个模型

## 注意事项

1. **观测维度**：确保测试数据的维度与模型训练时的观测空间一致
2. **数据范围**：观测数据应在[0,1]范围内，与训练时的归一化保持一致
3. **模型路径**：确保模型文件路径正确且文件存在
4. **算法匹配**：使用正确的算法类型加载对应的模型文件

## 扩展使用

### 自定义测试场景

可以在代码中添加自定义的测试场景：

```python
# 自定义场景
custom_scenario = np.array([
    1, 0, 0, 0,  # 相位0激活
    1,           # 满足最小绿灯时间
    # ... 自定义的密度和队列数据
], dtype=np.float32)

action, _ = model.predict(custom_scenario.reshape(1, -1))
print(f"自定义场景预测动作: {action}")
```

### 批量测试多个模型

可以修改脚本来测试多个模型文件：

```python
models = [
    ("model1.zip", "DQN"),
    ("model2.zip", "SAC"),
    # 添加更多模型
]

for model_path, algo in models:
    test_model_offline(model_path, algo)
```

这样就可以实现真正脱离仿真环境的模型测试，大大提高了测试效率和灵活性。