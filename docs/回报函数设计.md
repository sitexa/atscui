# 分析几个回报函数的原理

##  现有回报函数分析

  在 sumo_core/envs/traffic_signal.py 中，定义了以下几个核心的回报函数：

  1. _diff_waiting_time_reward (默认)


   * 原理: 回报 = 上一时刻路口总等待时间 - 当前时刻路口总等待时间。它计算的是累积等待时间的变化量。
   * 特点:
       * 目标导向: 非常直接地以“减少等待时间”为目标。
       * 相对奖励: 这是一个相对值。如果动作能让等待时间减少，回报为正；如果等待时间增加（比如切换相位导致另一方向
         车辆开始等待），回报为负。
   * 适用场合: 适用于那些以“最小化路网总等待时间”为核心优化指标的通用场景。
   * 潜在问题 (导致决策单一的原因):
       * 短视行为 (Myopic Behavior): 模型可能会满足于一个能带来微小、稳定正回报的动作。例如，保持“南北左转”绿灯，
         可以持续服务一小部分车流，使总等待时间的增量保持在较低水平。切换到压力更大的“东西直行”可能会瞬间导致总等
         待时间大幅上升（因为新方向的车流开始移动，但之前的等待时间会计入），从而获得一个巨大的负回报。模型为了避
         免这个瞬时的负回报，宁愿选择不切换。
       * 缺乏对“紧迫性”的感知: 它只关心总量的变化，而无法区分“哪个方向更需要绿灯”。一个排了100辆车的方向和一个排了
         10辆车的方向，在它看来可能没有质的区别，只要总量在减少就行。

  2. _queue_reward


   * 原理: 回报 = -路口总排队车辆数。它直接将排队车辆总数作为惩罚。
   * 特点:
       * 简单直接: 逻辑清晰，目标就是让路口排队的车辆越少越好。
       * 绝对惩罚: 这是一个绝对值。只要有车排队，就是负回报。
   * 适用场合: 适用于那些对路口排队长度非常敏感，希望不惜一切代价清空队列的场景（例如，防止队尾溢出到上游路口）。
   * 潜在问题:
       * 与 _diff_waiting_time_reward 类似，它也无法感知到压力的不均衡。它可能会满足于一个能让总排队数维持在某个
       “不算太差”水平的动作，而不敢切换到可能暂时增加总排队数（但长期更优）的相位。

  3. _average_speed_reward

   * 原理: 回报 = 路口所有车辆的平均速度。
   * 特点:
       * 关注通行效率: 目标是让路网中的车辆跑得尽可能快。
       * 间接指标: 速度是交通状况的一个良好指标，但比较间接。
   * 适用场合: 适用于高速路或城市快速路等场景，其中保持车流速度是首要目标。
   * 潜在问题:
       * 忽略了停车的车辆: 这个指标可能会忽略那些已经停在队首、速度为零的车辆的痛苦。为了让少数几辆车跑得快，它可
         能会让大量车一直排队等待。
       * 对拥堵不敏感: 在严重拥堵时，大家速度都很慢，这个指标的区分度会下降。

  4. _pressure_reward (现有版本)

   * 原理: 回报 = 出口车道上的车辆数 - 入口车道上的车辆数。
   * 特点:
       * 概念超前: 引入了“压力”的概念，试图衡量路口的疏散能力和进入需求的差异。
       * 定义模糊: 这个定义比较模糊。它衡量的是整个路口（所有入口 vs 所有出口）的车辆数差异，而不是冲突相位之间的压力差异。
   * 适用场合: 理论上希望平衡进出路口的车流量。
   * 潜在问题:
       * 无法指导相位选择: 这个回报值无法告诉模型“应该切换到哪个相位”。因为它计算的是一个全局的、与具体相位无关的
         压力值。无论模型选择哪个相位，这个回报值的变化可能都不明显，因此无法有效指导决策。

  4. 计划添加的回报函数 (_pressure_reward_v2)


   * 原理: 回报 = 所有红灯车道上的排队车辆数 - 所有绿灯车道上的排队车辆数。
   * 核心思想: 奖励那些将绿灯分配给排队最长（压力最大）方向的决策。

##  对比与优缺点分析

  ┌────────────────────┬──────────——————────┬──────────────────────────────——————————————─────┬───────——————————————────────────────────────┐
  │ 回报函数            │ 核心指标             │ 优点                                            │ 缺点                                         │
  ├────────────────────┼────────——————──────┼──────────────────────────────——————————————─────┼─────────────────────────——————————————──────┤
  │ `_diff_waiting_... │ 等待时间**变化量**   │ 直接优化等待时间，目标明确。                         │ **短视**，可能陷入局部最优，导致决策单一。        │
  │ `_queue_reward`    │ **总**排队车辆数     │ 简单，能有效减少排队。                              │ 无法感知压力不均衡，同样可能决策单一。            │
  │ `_average_speed... │ 平均车速            │ 关注通行效率。                                     │ 对停车等待的车辆不敏感。                        │
  │ `_pressure_rewa... │ 进出车流量**差**     │ 概念先进。                                        │ 定义模糊，无法有效指导相位选择。                 │
  │ **`_pressure_re... │ **红绿灯相位间*...   │ **动态适应性强**，直接感知拥堵方向；**目标明确**，缓... │ **可能导致“饥饿”**（车少的方向长时间得不到绿灯... │
  └────────────────────┴───────────——————───┴───────────────────────────────———————————————────┴──────────────────────────—————————————─────┘


  _pressure_reward_v2 的优缺点详述：

  优点:


   1. 极具前瞻性和主动性: 它不再被动地计算已经产生的“等待时间”，而是主动地去解决产生等待时间的根源——红灯方向的排队
      。这使得智能体更加“聪明”。
   2. 动态适应性极强: 交通状况是瞬息万变的。当东西方向压力大时，它会倾向于给东西方向绿灯；当南北方向压力大时，它又
      会切换到南北方向。这正是我们希望看到的自适应行为。
   3. 能有效解决决策单一问题: 因为交通压力总是在不同方向间转移，模型几乎不可能一直选择同一个相位，否则未被服务的方
      向压力会持续累积，最终导致回报函数给出一个强烈的信号，迫使模型切换相位。

  缺点:


   1. 可能导致“饥饿”问题 (Starvation): 如果一个方向的车流量持续很小，它的压力值可能永远也竞争不过主干道。这可能导致
      这个小方向的车辆等待时间过长。这是一个典型的“效率”与“公平”的权衡。
   2. 对绿灯方向排队敏感: 红灯排队 - 绿灯排队 这个公式，意味着它会惩罚“绿灯方向的排队”。如果绿灯方向车队很长还没走
      完，它可能会倾向于过早地切换相位，以减少这个“负分项”。这需要通过设置合理的min_green（最小绿灯时间）来缓解。

  结论

  现有的回报函数，特别是默认的
  _diff_waiting_time_reward，虽然目标明确，但其“短视”的特性是导致模型决策单一的主要原因。


  新提出的 _pressure_reward_v2 通过引入冲突相位间的压力差这一核心概念，旨在从根本上改变模型的决策逻辑，使其从一
  个“被动的等待时间减少者”转变为一个“主动的交通压力疏导者”。尽管它也有一些潜在的权衡（如饥饿问题），但它能更有效
  地应对多变的交通状况，是解决当前问题的最佳方案。